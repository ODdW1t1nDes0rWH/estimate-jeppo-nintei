<script>
  // ...（既存のヘルパー等はそのまま）

  // すべてのアイテムチェック状態をまとめて変更
  function setAllItemsChecked(checked){
    document.querySelectorAll('.item input[type="checkbox"]').forEach(cb=>{ cb.checked = checked; });
    updateAllSectionMasters();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // 既存のアイテム用チェックボックス生成などはこの中で実施済みの想定

    // グローバル一括ON/OFF（typeを明示）
    const btnCheckAll = document.getElementById('checkAll');
    const btnUncheckAll = document.getElementById('uncheckAll');
    if(btnCheckAll){ btnCheckAll.type = 'button'; btnCheckAll.addEventListener('click', ()=> setAllItemsChecked(true)); }
    if(btnUncheckAll){
      btnUncheckAll.type = 'button';
      btnUncheckAll.addEventListener('click', ()=>{
        setAllItemsChecked(false);
        // セクションのマスターも解除
        document.querySelectorAll('.section-title input.section-master[type="checkbox"]').forEach(cb=>{
          cb.checked=false; cb.indeterminate=false;
        });
      });
    }

    // セクション単位のボタン型コントロールを追加したい場合（任意）
    eachSection((sec, title)=>{
      const controls = title.querySelector('.section-controls');
      if(!controls) return;
      // 既に生成済みならスキップ
      if(controls.querySelector('.section-check-all')) return;

      const btnAll = document.createElement('button');
      btnAll.className = 'btn secondary section-check-all';
      btnAll.type = 'button';
      btnAll.textContent = 'このセクションをすべて選択';

      const btnNone = document.createElement('button');
      btnNone.className = 'btn secondary section-uncheck-all';
      btnNone.type = 'button';
      btnNone.textContent = 'すべて解除';

      controls.append(btnAll, btnNone);
    });

    // セクション単位の一括操作（イベント委譲）
    document.addEventListener('click',(e)=>{
      if(e.target.matches('.section-check-all, .section-uncheck-all')){
        const section = e.target.closest('section');
        const checked = e.target.matches('.section-check-all');
        section.querySelectorAll('.item input[type="checkbox"]').forEach(cb=>{ cb.checked = checked; });
        updateSectionMaster(section);
      }
    });
  });
</script>
